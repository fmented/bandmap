async function getGeo(){target.innerHTML='<div class="lds-ring"><div></div><div></div><div></div></div>';var e=(await fetch("./countries.geojson",{cache:"force-cache"}).then(e=>e.json())).features;window.geofeatures=e,target.removeChild(target.childNodes[0])}var styles={opacity:1,color:"#ee1122",fillColor:"#222222",fillOpacity:1,weight:.5};function randomColor(){return`#${Math.floor(16777215*Math.random()).toString(16)}`}var map,layerSelected,ctext,target=document.querySelector("#map");async function init(){await getGeo(),(map=L.map(target,{center:[0,0],zoom:1,retina:!0})).on("mousedown",function(){sessionStorage.getItem("genre")==selectedGenre&&(t.setStyle(styles),indicator.innerText="No Country Selected")}),map.on("mouseover",function(){0==e&&checkBar()&&(t.setStyle(styles),indicator.innerText="No Country Selected")}),map.attributionControl.setPrefix('<a href="https://leafletjs.com" target="_blank" style="color:#666;">Leaflet</a> | <a href="https://musicbrainz.org" target="_blank" style="color:#666;">Musicbrainz</a> | <a href="https://open.spotify.com/artist/5JEvywYloyf0QPHBEyBQlO" target="_blank" style="color:#666;">Fmented</a>'),bar.onmouseover=function(){e=!1};var e=!1,t=L.geoJSON(window.geofeatures,{style:styles,onEachFeature:function(n,l){l.on("click",async function(e){t.setStyle(styles);var l=n.properties.ISO_A2;sessionStorage.setItem("origin",l),layerSelected=this,ctext=n.properties.ADMIN;let r=(await fetch(`https://musicbrainz.org/ws/2/artist/?query=tag:${selectedGenre}%20AND%20country:${sessionStorage.getItem("origin")}&inc=url-rels&fmt=json`).then(e=>{if(200==e.status)return e.json()})).artists;await addBandlist(r),this.setStyle({color:"gold",fillColor:"#eee"}),indicator.innerText=n.properties.ADMIN}),l.on("mouseup",function(n){t.setStyle(styles),e=!0}),l.on("mouseover",function(){0==e&&this.setStyle({color:"red",fillColor:"#999"}),indicator.innerText=n.properties.ADMIN}),l.on("mouseout",function(){1!=e&&t.setStyle(styles),null!=layerSelected&&(layerSelected.setStyle({color:"gold",fillColor:"#eee"}),indicator.innerText=ctext)})}}).addTo(map)}async function addBandlist(e){3==bar.childElementCount&&bar.removeChild(bar.children[2]),2==bar.childElementCount&&bar.removeChild(bar.children[1]);let t=document.createElement("div");t.style.display="flex",t.style.overflowX="scroll",t.classList.add("list"),e.forEach(async function(e){let n=document.createElement("div");n.classList.add("card"),n.style.justifyContent="center";let l=document.createElement("div");l.classList.add("card-base");let r=document.createElement("h2");r.classList.add("band"),r.innerText=e.name,r.style.cursor="pointer",r.onclick=async function(){await addAlbumlist(e.id,e.name)},r.ondblclick=function(){window.open(`https://musicbrainz.org/artist/${e.id}`,"_blank")},r.setAttribute("title",`Click: Check ${e.name} Releases\nDouble-Click: Find More About ${e.name}`),l.append(r),n.appendChild(l),t.appendChild(n)}),t.style.width=screen.width-parseInt(window.getComputedStyle(filter).width.replace("px",""))-32+"px",bar.appendChild(t)}async function checkCover(e){let t=(await fetch(`https://musicbrainz.org/ws/2/release?release-group=${e}&fmt=json`,{}).then(e=>{if(200==e.status)return e.json()})).releases;return await getImageSource(t)}async function getImageSource(e){for(let t=0;t<e.length;t++){let n=e[t];if(1==n["cover-art-archive"].artwork){return[(await fetch(`https://coverartarchive.org/release/${n.id}`,{}).then(e=>{if(200==e.status)return e.json()})).images[0].image,n.id]}}return["./noimage.png",e[e.length-1].id]}async function addAlbumlist(e,t){bar.children[1].style.display="none";let n=document.createElement("div");n.classList.add("list");let l=await fetch(`https://musicbrainz.org/ws/2/release-group?artist=${e}&fmt=json`,{}).then(e=>{if(200==e.status)return e.json()}),r=await l["release-groups"];n.style.display="flex";let i=document.createElement("button");i.innerText=">>",i.classList.add("band"),i.classList.add("collapse"),i.setAttribute("title","Collapse"),i.onclick=function(){bar.children[1].style.display="flex",bar.removeChild(n)},n.appendChild(i),bar.appendChild(n);let a=window.getComputedStyle(filter).width.replace("px",""),o=window.getComputedStyle(i).width.replace("px",""),s=screen.width-parseInt(a)-parseInt(o)-50,c=window.getComputedStyle(filter).height.replace("px","");if(0==r.length){let e=document.createElement("div");e.style.display="block",e.style.width=s+"px",e.style.textAlign="center",e.style.paddingTop=Math.floor(parseInt(c)/2)+"px",e.innerText="No Album Yet",n.appendChild(e)}else{let e=document.createElement("div");e.style.display="flex",e.style.width=s+"px",e.style.overflowX="scroll",e.style.overflowY="hidden",e.classList.add("list"),r.forEach(async function(n){let l=document.createElement("div");l.classList.add("card-base");let r=document.createElement("div");r.classList.add("card");let i=document.createElement("img"),a=await checkCover(n.id);i.src=a[0],i.height=.7*c,i.width=.7*c,i.classList.add("band"),i.style.cursor="pointer",i.setAttribute("title","More Information"),i.onclick=function(){window.open(`https://musicbrainz.org/release/${a[1]}`,"_blank")},r.appendChild(i);let o=document.createElement("p");o.innerText=n.title,o.style.cursor="pointer",o.setAttribute("title","Search on Spotify"),o.onclick=function(){window.open(`https://open.spotify.com/search/${t} ${n.title}`,"_blank")},r.appendChild(o),l.appendChild(r),e.appendChild(l)}),n.appendChild(e)}}init();var bar=document.querySelector(".bottom-bar"),filter=document.querySelector("#filter"),selectedGenre=filter.value,indicator=document.querySelector("#indicator");function checkBar(){return bar.children.length<2}filter.onchange=async function(){selectedGenre=this.value,null!=layerSelected&&(layerSelected.fire("click"),layerSelected.setStyle({color:"gold",fillColor:"#eee"}))};